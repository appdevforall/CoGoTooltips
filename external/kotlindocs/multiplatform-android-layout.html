<html>
 <head>
  <meta charset="utf-8"/>
  <link href="doc_style.css" rel="stylesheet"/>
 </head>
 <body>
  <a class="menu-link" href="toc.html">
   MENU
  </a>
  <hr/>
  <div class="article-content">
   <h1 data-toc="multiplatform-android-layout" id="multiplatform-android-layout.md">
    Android source set layout
   </h1>
   <p id="-e9579k_2">
    The new Android source set layout was introduced in Kotlin 1.8.0 and became the default in 1.9.0. Follow this guide to understand the key differences between the deprecated and the new layouts, as well as how to migrate your projects.
   </p>
   <aside class="prompt" data-title="" data-type="tip" id="-e9579k_3">
    <p id="-e9579k_10">
     You don't need to implement all the suggestions, only those that are applicable to your particular projects.
    </p>
   </aside>
   <section class="chapter">
    <h2 data-toc="check-the-compatibility" id="check-the-compatibility">
     Check the compatibility
    </h2>
    <p id="-e9579k_11">
     The new layout requires Android Gradle plugin 7.0 or later and is supported in Android Studio 2022.3 and later. Check your version of the Android Gradle plugin and upgrade if necessary.
    </p>
   </section>
   <section class="chapter">
    <h2 data-toc="rename-kotlin-source-sets" id="rename-kotlin-source-sets">
     Rename Kotlin source sets
    </h2>
    <p id="-e9579k_12">
     If applicable, rename the source sets in your project, following this pattern:
    </p>
    <div class="table-wrapper">
     <table class="wide" id="-e9579k_13">
      <thead>
       <tr class="ijRowHead" id="-e9579k_16">
        <th id="-e9579k_18">
         <p>
          Previous source set layout
         </p>
        </th>
        <th id="-e9579k_19">
         <p>
          New source set layout
         </p>
        </th>
       </tr>
      </thead>
      <tbody>
       <tr id="-e9579k_17">
        <td id="-e9579k_20">
         <p>
          <code class="code" id="-e9579k_22">
           targetName
          </code>
          +
          <code class="code" id="-e9579k_23">
           AndroidSourceSet.name
          </code>
         </p>
        </td>
        <td id="-e9579k_21">
         <p>
          <code class="code" id="-e9579k_24">
           targetName
          </code>
          +
          <code class="code" id="-e9579k_25">
           AndroidVariantType
          </code>
         </p>
        </td>
       </tr>
      </tbody>
     </table>
    </div>
    <p id="-e9579k_14">
     <code class="code" id="-e9579k_26">
      {AndroidSourceSet.name}
     </code>
     maps to
     <code class="code" id="-e9579k_27">
      {KotlinSourceSet.name}
     </code>
     as follows:
    </p>
    <div class="table-wrapper">
     <table class="wide" id="-e9579k_15">
      <thead>
       <tr class="ijRowHead" id="-e9579k_28">
        <th id="-e9579k_32">
        </th>
        <th id="-e9579k_33">
         <p>
          Previous source set layout
         </p>
        </th>
        <th id="-e9579k_34">
         <p>
          New source set layout
         </p>
        </th>
       </tr>
      </thead>
      <tbody>
       <tr id="-e9579k_29">
        <td id="-e9579k_35">
         <p>
          main
         </p>
        </td>
        <td id="-e9579k_36">
         <p>
          androidMain
         </p>
        </td>
        <td id="-e9579k_37">
         <p>
          androidMain
         </p>
        </td>
       </tr>
       <tr id="-e9579k_30">
        <td id="-e9579k_38">
         <p>
          test
         </p>
        </td>
        <td id="-e9579k_39">
         <p>
          androidTest
         </p>
        </td>
        <td id="-e9579k_40">
         <p>
          android
          <b id="-e9579k_41">
           Unit
          </b>
          Test
         </p>
        </td>
       </tr>
       <tr id="-e9579k_31">
        <td id="-e9579k_42">
         <p>
          androidTest
         </p>
        </td>
        <td id="-e9579k_43">
         <p>
          android
          <b id="-e9579k_45">
           Android
          </b>
          Test
         </p>
        </td>
        <td id="-e9579k_44">
         <p>
          android
          <b id="-e9579k_46">
           Instrumented
          </b>
          Test
         </p>
        </td>
       </tr>
      </tbody>
     </table>
    </div>
   </section>
   <section class="chapter">
    <h2 data-toc="move-source-files" id="move-source-files">
     Move source files
    </h2>
    <p id="-e9579k_47">
     If applicable, move your source files to the new directories, following this pattern:
    </p>
    <div class="table-wrapper">
     <table class="wide" id="-e9579k_48">
      <thead>
       <tr class="ijRowHead" id="-e9579k_51">
        <th id="-e9579k_53">
         <p>
          Previous source set layout
         </p>
        </th>
        <th id="-e9579k_54">
         <p>
          New source set layout
         </p>
        </th>
       </tr>
      </thead>
      <tbody>
       <tr id="-e9579k_52">
        <td id="-e9579k_55">
         <p>
          The layout had additional
          <code class="code" id="-e9579k_57">
           /kotlin
          </code>
          SourceDirectories
         </p>
        </td>
        <td id="-e9579k_56">
         <p>
          <code class="code" id="-e9579k_58">
           src/{KotlinSourceSet.name}/kotlin
          </code>
         </p>
        </td>
       </tr>
      </tbody>
     </table>
    </div>
    <p id="-e9579k_49">
     <code class="code" id="-e9579k_59">
      {AndroidSourceSet.name}
     </code>
     maps to
     <code class="code" id="-e9579k_60">
      {SourceDirectories included}
     </code>
     as follows:
    </p>
    <div class="table-wrapper">
     <table class="wide" id="-e9579k_50">
      <thead>
       <tr class="ijRowHead" id="-e9579k_61">
        <th id="-e9579k_65">
        </th>
        <th id="-e9579k_66">
         <p>
          Previous source set layout
         </p>
        </th>
        <th id="-e9579k_67">
         <p>
          New source set layout
         </p>
        </th>
       </tr>
      </thead>
      <tbody>
       <tr id="-e9579k_62">
        <td id="-e9579k_68">
         <p>
          main
         </p>
        </td>
        <td id="-e9579k_69">
         <p>
          src/androidMain/kotlin
         </p>
         <br/>
         <p>
          src/main/kotlin
         </p>
         <br/>
         <p>
          src/main/java
         </p>
        </td>
        <td id="-e9579k_70">
         <p>
          src/androidMain/kotlin
         </p>
         <br/>
         <p>
          src/main/kotlin
         </p>
         <br/>
         <p>
          src/main/java
         </p>
        </td>
       </tr>
       <tr id="-e9579k_63">
        <td id="-e9579k_75">
         <p>
          test
         </p>
        </td>
        <td id="-e9579k_76">
         <p>
          src/androidTest/kotlin
         </p>
         <br/>
         <p>
          src/test/kotlin
         </p>
         <br/>
         <p>
          src/test/java
         </p>
        </td>
        <td id="-e9579k_77">
         <p>
          src/android
          <b id="-e9579k_80">
           Unit
          </b>
          Test/kotlin
         </p>
         <br/>
         <p>
          src/test/kotlin
         </p>
         <br/>
         <p>
          src/test/java
         </p>
        </td>
       </tr>
       <tr id="-e9579k_64">
        <td id="-e9579k_83">
         <p>
          androidTest
         </p>
        </td>
        <td id="-e9579k_84">
         <p>
          src/android
          <b id="-e9579k_86">
           Android
          </b>
          Test/kotlin
         </p>
         <br/>
         <p>
          src/androidTest/java
         </p>
        </td>
        <td id="-e9579k_85">
         <p>
          src/android
          <b id="-e9579k_88">
           Instrumented
          </b>
          Test/kotlin
         </p>
         <br/>
         <p>
          src/androidTest/java,
          <b id="-e9579k_90">
           src/androidTest/kotlin
          </b>
         </p>
        </td>
       </tr>
      </tbody>
     </table>
    </div>
   </section>
   <section class="chapter">
    <h2 data-toc="move-the-androidmanifest-xml-file" id="move-the-androidmanifest-xml-file">
     Move the AndroidManifest.xml file
    </h2>
    <p id="-e9579k_91">
     If you have the
     <code class="code" id="-e9579k_95">
      AndroidManifest.xml
     </code>
     file in your project, move it to the new directory, following this pattern:
    </p>
    <div class="table-wrapper">
     <table class="wide" id="-e9579k_92">
      <thead>
       <tr class="ijRowHead" id="-e9579k_96">
        <th id="-e9579k_98">
         <p>
          Previous source set layout
         </p>
        </th>
        <th id="-e9579k_99">
         <p>
          New source set layout
         </p>
        </th>
       </tr>
      </thead>
      <tbody>
       <tr id="-e9579k_97">
        <td id="-e9579k_100">
         <p>
          src/{
          <b id="-e9579k_102">
           Android
          </b>
          SourceSet.name}/AndroidManifest.xml
         </p>
        </td>
        <td id="-e9579k_101">
         <p>
          src/{
          <b id="-e9579k_103">
           Kotlin
          </b>
          SourceSet.name}/AndroidManifest.xml
         </p>
        </td>
       </tr>
      </tbody>
     </table>
    </div>
    <p id="-e9579k_93">
     <code class="code" id="-e9579k_104">
      {AndroidSourceSet.name}
     </code>
     maps to
     <code class="code" id="-e9579k_105">
      {AndroidManifest.xml location}
     </code>
     as follows:
    </p>
    <div class="table-wrapper">
     <table class="wide" id="-e9579k_94">
      <thead>
       <tr class="ijRowHead" id="-e9579k_106">
        <th id="-e9579k_109">
        </th>
        <th id="-e9579k_110">
         <p>
          Previous source set layout
         </p>
        </th>
        <th id="-e9579k_111">
         <p>
          New source set layout
         </p>
        </th>
       </tr>
      </thead>
      <tbody>
       <tr id="-e9579k_107">
        <td id="-e9579k_112">
         <p>
          main
         </p>
        </td>
        <td id="-e9579k_113">
         <p>
          src/main/AndroidManifest.xml
         </p>
        </td>
        <td id="-e9579k_114">
         <p>
          src/
          <b id="-e9579k_115">
           android
          </b>
          Main/AndroidManifest.xml
         </p>
        </td>
       </tr>
       <tr id="-e9579k_108">
        <td id="-e9579k_116">
         <p>
          debug
         </p>
        </td>
        <td id="-e9579k_117">
         <p>
          src/debug/AndroidManifest.xml
         </p>
        </td>
        <td id="-e9579k_118">
         <p>
          src/
          <b id="-e9579k_119">
           android
          </b>
          Debug/AndroidManifest.xml
         </p>
        </td>
       </tr>
      </tbody>
     </table>
    </div>
   </section>
   <section class="chapter">
    <h2 data-toc="check-the-relationship-between-android-and-common-tests" id="check-the-relationship-between-android-and-common-tests">
     Check the relationship between Android and common tests
    </h2>
    <p id="-e9579k_120">
     The new Android source set layout changes the relationship between Android-instrumented tests (renamed to
     <code class="code" id="-e9579k_125">
      androidInstrumentedTest
     </code>
     in the new layout) and common tests.
    </p>
    <p id="-e9579k_121">
     Previously, the
     <code class="code" id="-e9579k_126">
      dependsOn
     </code>
     relationship between
     <code class="code" id="-e9579k_127">
      androidAndroidTest
     </code>
     and
     <code class="code" id="-e9579k_128">
      commonTest
     </code>
     was the default. It meant the following:
    </p>
    <ul class="list _bullet" id="-e9579k_122">
     <li class="list__item" id="-e9579k_129">
      <p>
       The code in
       <code class="code" id="-e9579k_132">
        commonTest
       </code>
       was available in
       <code class="code" id="-e9579k_133">
        androidAndroidTest
       </code>
       .
      </p>
     </li>
     <li class="list__item" id="-e9579k_130">
      <p>
       <code class="code" id="-e9579k_134">
        expect
       </code>
       declarations in
       <code class="code" id="-e9579k_135">
        commonTest
       </code>
       had to have corresponding
       <code class="code" id="-e9579k_136">
        actual
       </code>
       implementations in
       <code class="code" id="-e9579k_137">
        androidAndroidTest
       </code>
       .
      </p>
     </li>
     <li class="list__item" id="-e9579k_131">
      <p>
       Tests declared in
       <code class="code" id="-e9579k_138">
        commonTest
       </code>
       were also running as Android instrumented tests.
      </p>
     </li>
    </ul>
    <p id="-e9579k_123">
     In the new Android source set layout, the
     <code class="code" id="-e9579k_139">
      dependsOn
     </code>
     relationship is not added by default. If you prefer the previous behavior, manually declare the following relationship in your
     <code class="code" id="-e9579k_140">
      build.gradle.kts
     </code>
     file:
    </p>
    <div class="code-block" data-lang="kotlin">
     kotlin {
// ...
    sourceSets {
        val commonTest by getting
        val androidInstrumentedTest by getting {
            dependsOn(commonTest)
        }
    }
}
    </div>
   </section>
   <section class="chapter">
    <h2 data-toc="adjust-the-implementation-of-android-flavors" id="adjust-the-implementation-of-android-flavors">
     Adjust the implementation of Android flavors
    </h2>
    <p id="-e9579k_141">
     Previously, the Kotlin Gradle plugin eagerly created source sets that corresponded to Android source sets containing
     <code class="code" id="-e9579k_145">
      debug
     </code>
     and
     <code class="code" id="-e9579k_146">
      release
     </code>
     build types or custom flavors like
     <code class="code" id="-e9579k_147">
      demo
     </code>
     and
     <code class="code" id="-e9579k_148">
      full
     </code>
     . It made the source sets accessible by using expressions like
     <code class="code" id="-e9579k_149">
      val androidDebug by getting { ... }
     </code>
     .
    </p>
    <p id="-e9579k_142">
     The new Android source set layout makes use of Android's
     <a data-external="true" href="https://developer.android.com/reference/tools/gradle-api/8.0/com/android/build/api/variant/AndroidComponentsExtension#onVariants(com.android.build.api.variant.VariantSelector,kotlin.Function1)" id="-e9579k_150" rel="noopener noreferrer">
      <code class="code" id="-e9579k_152">
       onVariants
      </code>
     </a>
     to create source sets. It makes such expressions invalid, leading to errors like
     <code class="code" id="-e9579k_151">
      org.gradle.api.UnknownDomainObjectException: KotlinSourceSet with name 'androidDebug' not found
     </code>
     .
    </p>
    <p id="-e9579k_143">
     To work around that, use the new
     <code class="code" id="-e9579k_153">
      invokeWhenCreated()
     </code>
     API in your
     <code class="code" id="-e9579k_154">
      build.gradle.kts
     </code>
     file:
    </p>
    <div class="code-block" data-lang="kotlin">
     kotlin {
// ...
    @OptIn(ExperimentalKotlinGradlePluginApi::class)
    sourceSets.invokeWhenCreated("androidFreeDebug") {
// ...
    }
}
    </div>
   </section>
   <div class="last-modified">
    Last modified: 16 December 2024
   </div>
   <div data-feedback-placeholder="true">
   </div>
  </div>
 </body>
</html>
